<!DOCTYPE html>
<html>
    <head>
        <script src="../../../lib/VSS.SDK.min.js"></script>
        <script src="../../library.js"></script>
        <script src="../widget_1x1/widget_1x1.js"></script>
        <link rel="stylesheet" href="../../styles.css" />

        <script type="text/javascript">
            VSS.init({
                explicitNotifyLoaded: true,
                usePlatformStyles: true
            });

            VSS.require(
                ["VSS/Service", "TFS/Dashboards/WidgetHelpers", "VSS/Context", "TFS/VersionControl/GitRestClient", "TFS/Core/RestClient"],
                async function (Service, WidgetHelpers, context, GitWebApi, RestClient)
                {
                    function testingLog(message) {
                        var $title = $('h2.ghazdo-title');
                        $title.text(message);
                    }

                    WidgetHelpers.IncludeWidgetStyles();
                    VSS.register("GHAzDoWidget.TestingWidget", async function () {
                        const webContext = VSS.getWebContext();
                        const project = webContext.project;
                        const organization = webContext.account.name;
                        const projectId = project.id;
                        // convert project.name to url encoding
                        const projectName = project.name.replace(/ /g, "%20").replace(/&/g, "%26");

                        consoleLog('project id: ' + projectId);
                        consoleLog('project name: ' + projectName);
                        consoleLog('organization name: ' + organization);

                        return {
                            load: async function (widgetSettings) {
                                var settings = logWidgetSettings(widgetSettings, VSS, "testingWidget");

                                documentCollection = "repos"
                                documentId = "testingWidgetInfo"
                                let document;
                                try {
                                    document = await getSavedDocument(VSS, documentCollection, documentId);
                                    testingLog('lastUpdated: ' + JSON.stringify(document.lastUpdated));
                                }
                                catch (err) {
                                    testingLog('error getting document: ' + JSON.stringify(err));
                                }

                                if (!document) {
                                    // store a new document for testing
                                    document = {
                                        "testing": "testing"
                                    }
                                    try {
                                        await saveDocument(VSS, documentCollection, documentId, document);
                                        testingLog('document saved');
                                    }
                                    catch (err) {
                                        testingLog('error saving document: ' + JSON.stringify(err));
                                    }
                                }

                                try {
                                    const projects = await getProjects(VSS, Service, RestClient);
                                    consoleLog(`Found [${projects?.length}] projects`);
                                    // show the project names:
                                    // make an array
                                    nameList = "";
                                    for (let index in projects) {
                                        const project = projects[index];
                                        consoleLog(`Checking project: [${JSON.stringify(project)}]`);
                                        nameList+=(`<li>${project.name}</li>\n`);
                                        // load the repos for this project:
                                        try {
                                            const repos = await getRepos(VSS, Service, GitWebApi, project.name);
                                            consoleLog(`Found [${repos?.length}] repos for project [${project.name}]`);

                                            if (repos.length > 0) {
                                                nameList+=(`<ul>\n`);
                                            }
                                            for (let repoIndex in repos) {
                                                const repo = repos[repoIndex];
                                                const repoAlerts = await getAlerts(organization, project.name, repo.id)
                                                consoleLog(`Found [${JSON.stringify(repoAlerts)}] dependency alerts for repo [${repo.name}]`)
                                                nameList+=(`<li>${repo.name} (${repoAlerts.dependencyAlerts}/${repoAlerts.secretAlerts}/${repoAlerts.codeAlerts})</li>\n`);
                                            }

                                            if (repos.length > 0) {
                                                nameList+=(`</ul>\n`);
                                            }
                                        }
                                        catch (err) {
                                            consoleLog(`error loading repos for project ${project.name}` + JSON.stringify(err));
                                        }
                                    };

                                    $queryinfocontainer = $('#query-info-container');
                                    $queryinfocontainer.append(`<ul>${nameList}</ul>`);
                                }
                                catch (err) {
                                    consoleLog('error loading projects: ' + JSON.stringify(err));
                                }

                                return WidgetHelpers.WidgetStatusHelper.Success();
                            }
                        }
                    });
                    VSS.notifyLoadSucceeded();
                }
            );
        </script>

    </head>
    <body>
        <div class="widget GHAzDo-widget">
            <h2 class="ghazdo-title" title="" style="font-size: 15px;text-align: left;">Testing info</h2>
            <div id="query-info-container" class="column-container" style="font-size: 15px;text-align: left;display: block;">
                Projects: </br>
            </div>
        </div>
    </body>
</html>